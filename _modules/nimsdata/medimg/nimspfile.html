<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>nimsdata.medimg.nimspfile &mdash; NIMSData  documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="NIMSData  documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">NIMSData  documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for nimsdata.medimg.nimspfile</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>
<span class="c">#</span>
<span class="c"># @author:  Gunnar Schaefer</span>
<span class="c">#           Kevin S Hahn</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">nimsdata.medimg.nimspfile</span>
<span class="sd">=========================</span>

<span class="sd">This module provides functions, classes and errors for fully minimally parsing</span>
<span class="sd">and reconstructing pfiles. Additional modules are required to enable</span>
<span class="sd">full parsing of pfiles, spiral reconstruction, and mux_epi reconstruction.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">bson</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">shlex</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">bson.json_util</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">medimg</span>
<span class="kn">import</span> <span class="nn">dcm.mr.ge</span>
<span class="kn">import</span> <span class="nn">dcm.mr.generic_mr</span>

<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">tempdir</span> <span class="k">as</span> <span class="n">tempfile</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="unpack_uid"><a class="viewcode-back" href="../../../nimsdata.html#nimsdata.medimg.nimspfile.unpack_uid">[docs]</a><span class="k">def</span> <span class="nf">unpack_uid</span><span class="p">(</span><span class="n">uid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert packed PFile UID to standard DICOM UID.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    uid : str</span>
<span class="sd">        packed PFile UID as a string</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    uid : str</span>
<span class="sd">        unpacked PFile UID as string</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">11</span> <span class="k">else</span> <span class="s">&#39;.&#39;</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="p">[(</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">uid</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pair</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>

</div>
<div class="viewcode-block" id="is_gzip"><a class="viewcode-back" href="../../../nimsdata.html#nimsdata.medimg.nimspfile.is_gzip">[docs]</a><span class="k">def</span> <span class="nf">is_gzip</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert packed PFile UID to standard DICOM UID.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    uid : str</span>
<span class="sd">        packed PFile UID as a string</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    uid : str</span>
<span class="sd">        unpacked PFile UID as string</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="n">compressed</span> <span class="o">=</span> <span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\x1f\x8b</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">compressed</span>

</div>
<div class="viewcode-block" id="get_version"><a class="viewcode-back" href="../../../nimsdata.html#nimsdata.medimg.nimspfile.get_version">[docs]</a><span class="k">def</span> <span class="nf">get_version</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine the pfile version of the file at filepath.</span>

<span class="sd">    An NIMSPFileError exception will be raised if the file is not a valid PFile.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filepath : str</span>
<span class="sd">        filepath of file to check</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    version : str</span>
<span class="sd">        PFile version number of file at filepath</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    NIMSPFileError : Exception</span>
<span class="sd">        error if the file is not a valid PFile</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fileobj</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_gzip</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">else</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>

    <span class="n">version_bytes</span> <span class="o">=</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">34</span><span class="p">);</span> <span class="n">logo</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;10s&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;10s&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\0</span><span class="s">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">version_bytes</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\x00\x00\xc0</span><span class="s">A&#39;</span><span class="p">:</span>
        <span class="n">version</span> <span class="o">=</span> <span class="mi">24</span>
    <span class="k">elif</span> <span class="n">version_bytes</span> <span class="o">==</span> <span class="s">&#39;V</span><span class="se">\x0e\xa0</span><span class="s">A&#39;</span><span class="p">:</span>
        <span class="n">version</span> <span class="o">=</span> <span class="mi">23</span>
    <span class="k">elif</span> <span class="n">version_bytes</span> <span class="o">==</span> <span class="s">&#39;J</span><span class="se">\x0c\xa0</span><span class="s">A&#39;</span><span class="p">:</span>
        <span class="n">version</span> <span class="o">=</span> <span class="mi">22</span>
    <span class="k">elif</span> <span class="n">version_bytes</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\x00\x00</span><span class="s">0A&#39;</span><span class="p">:</span>
        <span class="n">version</span> <span class="o">=</span> <span class="mi">12</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">NIMSPFileError</span><span class="p">(</span><span class="n">fileobj</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&#39; is not a valid PFile or of an unsupported version&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">logo</span> <span class="o">!=</span> <span class="s">&#39;GE_MED_NMR&#39;</span> <span class="ow">and</span> <span class="n">logo</span> <span class="o">!=</span> <span class="s">&#39;INVALIDNMR&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">NIMSPFileError</span><span class="p">(</span><span class="n">fileobj</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&#39; is not a valid PFile&#39;</span><span class="p">)</span>
    <span class="n">fileobj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">version</span>

</div>
<div class="viewcode-block" id="NIMSPFileError"><a class="viewcode-back" href="../../../nimsdata.html#nimsdata.medimg.nimspfile.NIMSPFileError">[docs]</a><span class="k">class</span> <span class="nc">NIMSPFileError</span><span class="p">(</span><span class="n">medimg</span><span class="o">.</span><span class="n">MedImgError</span><span class="p">):</span>
    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="NIMSPFile"><a class="viewcode-back" href="../../../nimsdata.html#nimsdata.medimg.nimspfile.NIMSPFile">[docs]</a><span class="k">class</span> <span class="nc">NIMSPFile</span><span class="p">(</span><span class="n">medimg</span><span class="o">.</span><span class="n">MedImgReader</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse and load data from a pfile.</span>

<span class="sd">    This class reads the data and/or header from a pfile, runs k-space reconstruction.</span>

<span class="sd">    NIMSPFile object can handle several different input types</span>
<span class="sd">        - .tgz of directory containing Pfile, and supporting files such as ref.dat, vrgf.dat and tensor.dat.</span>
<span class="sd">        - a single pfile, either gz or uncompressed.</span>

<span class="sd">    tgz cannot be &quot;full parsed&quot;.  setting full_parse=True, with an input tgz, will raise an exception.</span>
<span class="sd">    nims2 input tgz format</span>
<span class="sd">    Pfile.7, Pfile.7ref.dat, Pfile.7vrgf.dat Pfile.7ref</span>

<span class="sd">    .. code:: python</span>

<span class="sd">        import nimsdata</span>
<span class="sd">        ds = nimsdata.parse(&#39;pfile.tgz&#39;, filetype=&#39;pfile&#39;, load_data=True)</span>
<span class="sd">        if not ds.failure_reason:</span>
<span class="sd">            nimsdata.write(ds, ds.data, outbase=&#39;output_name&#39;, filetype=&#39;nifti&#39;)</span>

<span class="sd">    Some pfiles require calibration files from another scan.  This &#39;aux_file&#39; can be provided</span>
<span class="sd">    during `__init__()`, or `load_data()`.</span>

<span class="sd">    .. code:: python</span>

<span class="sd">        import nimsdata</span>
<span class="sd">        ds = nimsdata.parse(&#39;muxarcepi_nocal.tgz&#39;, filetype=&#39;pfile&#39;, load_data=True, aux_file=&#39;muxarcepi_cal.tgz&#39;)</span>
<span class="sd">        if not ds.failure_reason:</span>
<span class="sd">            nimsdata.write(ds, ds.data, outbase=&#39;output_name&#39;, filetype=&#39;nifti&#39;)</span>

<span class="sd">    .. code:: python</span>

<span class="sd">        import nimsdata</span>
<span class="sd">        ds = nimsdata.parse(&#39;muxarcepi_nocal.tgz&#39;, filetype=&#39;pfile&#39;, load_data=False)</span>
<span class="sd">        ds.load_data(aux_file=&#39;muxarcepi_cal.tgz&#39;)</span>
<span class="sd">        if no ds.failure_reason:</span>
<span class="sd">            nimsdata.write(ds, ds.data, outbase=&#39;output_name&#39;, filetype=&#39;nifti&#39;)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">domain</span> <span class="o">=</span> <span class="s">u&#39;mr&#39;</span>
    <span class="n">filetype</span> <span class="o">=</span> <span class="s">u&#39;pfile&#39;</span>
    <span class="n">parse_priority</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">state</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;orig&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">load_data</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">full_parse</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">tempdir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">aux_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">num_jobs</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_virtual_coils</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">notch_thresh</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">recon_type</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read basic sorting information.</span>

<span class="sd">        There are a lot of parameters; most of the parameters only apply to mux_epi scans. The muxepi only</span>
<span class="sd">        parameters are num_jobs, num_virtual_coils, notch_thresh, recon_type and aux_file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath : str</span>
<span class="sd">            path to pfile.7 or pfile.tgz</span>
<span class="sd">        load_data : bool [default False]</span>
<span class="sd">            load all data and run reconstruction</span>
<span class="sd">        full_parse : bool [default False]</span>
<span class="sd">            full parse the input file, only applies to pfile.7 inputs</span>
<span class="sd">        tempdir : str</span>
<span class="sd">            path prefix to use for temp directory</span>
<span class="sd">        num_jobs : int</span>
<span class="sd">            muxepi only, number of simultaneous jobs</span>
<span class="sd">        num_virtual_coils : int</span>
<span class="sd">            muxepi only, number of virtual coils</span>
<span class="sd">        notch_thresh : int</span>
<span class="sd">            muxepi only, number of virtual coils</span>
<span class="sd">        recon_type : NoneType or str</span>
<span class="sd">            muxepi only, if recon_type is &#39;sense&#39;, then run sense recon</span>
<span class="sd">        aux_file : None or str</span>
<span class="sd">            path to pfile.tgz that contains valid vrgf.dat and ref.dat files</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NIMSPFile</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>       <span class="c"># sets self.filepath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full_parsed</span> <span class="o">=</span> <span class="bp">False</span>                        <span class="c"># indicates if fully parsed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dirpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span>   <span class="c"># what contains the input file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span>
        <span class="c"># TODO setting the file name and extension should be different for .7 and .7.tgz</span>
        <span class="c"># if pfile_arc.tgz, file_name = pfile_arc, file_ext = .tgz</span>
        <span class="c"># if P?????.7,   file_name = P?????, file_ext = .7</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_jobs</span> <span class="o">=</span> <span class="n">num_jobs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_vcoils</span> <span class="o">=</span> <span class="n">num_virtual_coils</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">notch_thresh</span> <span class="o">=</span> <span class="n">notch_thresh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recon_type</span> <span class="o">=</span> <span class="n">recon_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aux_file</span> <span class="o">=</span> <span class="n">aux_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span> <span class="o">=</span> <span class="n">tempdir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">None</span>


        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;parsing </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">filepath</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">is_tarfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">):</span>  <span class="c"># tgz; find json with a [&#39;header&#39;] section</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;tgz&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">archive</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ti</span> <span class="ow">in</span> <span class="n">archive</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ti</span><span class="o">.</span><span class="n">isreg</span><span class="p">():</span>
                        <span class="k">continue</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">_hdr</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">archive</span><span class="o">.</span><span class="n">extractfile</span><span class="p">(</span><span class="n">ti</span><span class="p">),</span> <span class="n">object_hook</span><span class="o">=</span><span class="n">bson</span><span class="o">.</span><span class="n">json_util</span><span class="o">.</span><span class="n">object_hook</span><span class="p">)[</span><span class="s">&#39;header&#39;</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c"># json file does not exist</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">; not a json file&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c"># header section does not exist</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">; header section does not exist&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;_min_parse_tgz&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">exam_uid</span> <span class="o">=</span> <span class="n">_hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;session&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_id</span> <span class="o">=</span> <span class="n">_hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;acquisition&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">_hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;timestamp&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">group_name</span> <span class="o">=</span> <span class="n">_hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;group&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">project_name</span> <span class="o">=</span> <span class="n">_hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;project&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">metadata_status</span> <span class="o">=</span> <span class="s">&#39;pending&#39;</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">NIMSPFileError</span><span class="p">(</span><span class="s">&#39;no json file with header section found. bailing&#39;</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c"># .7 or .7.gz, doing it old world style</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">get_version</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_full_parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span> <span class="k">if</span> <span class="n">full_parse</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span>  <span class="c"># full_parse arg indicates run full_parse</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NIMSPFileError</span><span class="p">(</span><span class="s">&#39;not a PFile? </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">load_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>

<div class="viewcode-block" id="NIMSPFile.infer_psd_type"><a class="viewcode-back" href="../../../nimsdata.html#nimsdata.medimg.nimspfile.NIMSPFile.infer_psd_type">[docs]</a>    <span class="k">def</span> <span class="nf">infer_psd_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Infer the psd type based on self.psd_type.</span>

<span class="sd">        Also makes any corrections to the psd_type to account for mis-named psds.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None : NoneType</span>
<span class="sd">            sets self.psd_type</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dcm</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">ge</span><span class="o">.</span><span class="n">infer_psd_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_type</span> <span class="o">==</span> <span class="s">&#39;epi&#39;</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">user6</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c"># XXX HACK check for misnamed mux scans</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psd_type</span> <span class="o">=</span> <span class="s">&#39;muxepi&#39;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;psd_name: </span><span class="si">%s</span><span class="s">, psd_type: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psd_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_type</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="NIMSPFile.infer_scan_type"><a class="viewcode-back" href="../../../nimsdata.html#nimsdata.medimg.nimspfile.NIMSPFile.infer_scan_type">[docs]</a>    <span class="k">def</span> <span class="nf">infer_scan_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Infer the scan type based on the dataset attributes.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None : NoneType</span>
<span class="sd">            sets self.scan_type</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dcm</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">generic_mr</span><span class="o">.</span><span class="n">infer_scan_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;scan_type: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_type</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_min_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse the minimum sorting information from a pfile.7.</span>

<span class="sd">        Does not work if input file is a tgz.  If NIMSPfile was init&#39;d with a tgz input, the tgz can be</span>
<span class="sd">        unpacked into a temporary directory, and then this function can parse the unpacked pfile.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath : str</span>
<span class="sd">            path to a pfile.7.  Does not accept pfile.tgz.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">filepath</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span>  <span class="c"># use filepath if provided, else fall back to self.filepath</span>
        <span class="k">if</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">is_tarfile</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">NIMSPFileError</span><span class="p">(</span><span class="s">&#39;_min_parse() expects a .7 or .7.gz&#39;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;_min_parse of </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">filepath</span><span class="p">)</span>

        <span class="n">fileobj</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_gzip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span> <span class="k">else</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>

        <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_date</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;10s&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;10s&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">26</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_time</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;8s&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;8s&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;h&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;h&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">70</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_echos</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;h&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;h&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">216</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec_user0</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;f&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;f&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">240</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec_user6</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;f&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;f&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">244</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec_user7</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;f&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;f&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">914</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">ileaves</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;h&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;h&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">24</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">22</span><span class="p">]:</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">143516</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">exam_no</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;H&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;H&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">145622</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">series_no</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;h&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;h&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">145762</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">series_desc</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;65s&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;65s&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\0</span><span class="s">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">145875</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">series_uid</span> <span class="o">=</span> <span class="n">unpack_uid</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;32s&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;32s&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">148388</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">im_datetime</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">148396</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">tr</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e6</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">148834</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">acq_no</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;h&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;h&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">148972</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;33s&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;33s&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\0</span><span class="s">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">24</span><span class="p">,</span> <span class="mi">23</span><span class="p">]:</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">144248</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">exam_uid</span> <span class="o">=</span> <span class="n">unpack_uid</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;32s&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;32s&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">144409</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;65s&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;65s&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\0</span><span class="s">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="mi">22</span><span class="p">:</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">144240</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">exam_uid</span> <span class="o">=</span> <span class="n">unpack_uid</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;32s&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;32s&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">144401</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;65s&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;65s&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\0</span><span class="s">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">61576</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">exam_no</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;H&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;H&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">61966</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">exam_uid</span> <span class="o">=</span> <span class="n">unpack_uid</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;32s&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;32s&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">62127</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;65s&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;65s&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\0</span><span class="s">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">62710</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">series_no</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;h&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;h&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">62786</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">series_desc</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;65s&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;65s&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\0</span><span class="s">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">62899</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">series_uid</span> <span class="o">=</span> <span class="n">unpack_uid</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;32s&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;32s&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">65016</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">im_datetime</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">65024</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">tr</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e6</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">65328</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">acq_no</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;h&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;h&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">65374</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;33s&quot;</span><span class="p">,</span> <span class="n">flleobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s">&quot;33s&quot;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\0</span><span class="s">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">im_datetime</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im_datetime</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">year</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_date</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\0</span><span class="s">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">))</span>
            <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_time</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\0</span><span class="s">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span> <span class="o">+</span> <span class="mi">1900</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">)</span>  <span class="c"># GE&#39;s epoch begins in 1900</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">infer_psd_type</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_type</span> <span class="o">==</span> <span class="s">&#39;spiral&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec_user0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_type</span> <span class="o">==</span> <span class="s">&#39;basic&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_echos</span> <span class="o">-</span> <span class="mi">6</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_type</span> <span class="o">==</span> <span class="s">&#39;muxepi&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec_user6</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ileaves</span> <span class="o">*</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec_user7</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prescribed_duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subj_code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_name</span> <span class="o">=</span> <span class="n">medimg</span><span class="o">.</span><span class="n">parse_patient_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patient_id</span><span class="p">,</span> <span class="s">&#39;ex&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">exam_no</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata_status</span> <span class="o">=</span> <span class="s">&#39;pending&#39;</span>

    <span class="k">def</span> <span class="nf">_full_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fully parse the input pfile.</span>

<span class="sd">        Attempts to import pfile version specific parser from pfile submodule.  Full parse is</span>
<span class="sd">        not possible without access to the pfile submodule.</span>

<span class="sd">        Does not work if input file is a tgz.  If NIMSPfile was init&#39;d with a tgz input, the tgz can be</span>
<span class="sd">        unpacked into a temporary directory, and then this function can parse the unpacked pfile.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath : str</span>
<span class="sd">            path to a pfile.7.  Does not accept pfile.tgz.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">filepath</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span>
        <span class="k">if</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">is_tarfile</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">NIMSPFileError</span><span class="p">(</span><span class="s">&#39;_full_parse() expects a .7 or .7.gz&#39;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;_full_parse of </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">filepath</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">pfile</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">__import__</span><span class="p">(</span><span class="s">&#39;pfile.pfile</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="nb">globals</span><span class="p">()),</span> <span class="s">&#39;pfile</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s">&#39;no pfile parser for v</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_gzip</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">else</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fileobj</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span> <span class="o">=</span> <span class="n">pfile</span><span class="o">.</span><span class="n">POOL_HEADER</span><span class="p">(</span><span class="n">fileobj</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NIMSPFileError</span><span class="p">(</span><span class="s">&#39;no pfile was read&#39;</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">None</span>    <span class="c"># data always starts as None</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">pfilename</span> <span class="o">=</span> <span class="s">&#39;P</span><span class="si">%05d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">run_int</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">exam_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">exam</span><span class="o">.</span><span class="n">ex_no</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exam_uid</span> <span class="o">=</span> <span class="n">unpack_uid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">exam</span><span class="o">.</span><span class="n">study_uid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">series_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">se_no</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">series_desc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">se_desc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\0</span><span class="s">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">series_uid</span> <span class="o">=</span> <span class="n">unpack_uid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">series_uid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">acq_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">scanactno</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">patient_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">exam</span><span class="o">.</span><span class="n">patidff</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\0</span><span class="s">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subj_code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_name</span> <span class="o">=</span> <span class="n">medimg</span><span class="o">.</span><span class="n">parse_patient_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patient_id</span><span class="p">,</span> <span class="s">&#39;ex&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exam_no</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subj_firstname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subj_lastname</span> <span class="o">=</span> <span class="n">medimg</span><span class="o">.</span><span class="n">parse_patient_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">exam</span><span class="o">.</span><span class="n">patnameff</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\0</span><span class="s">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subj_dob</span> <span class="o">=</span> <span class="n">medimg</span><span class="o">.</span><span class="n">parse_patient_dob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">exam</span><span class="o">.</span><span class="n">dateofbirth</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\0</span><span class="s">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subj_sex</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;male&#39;</span><span class="p">,</span> <span class="s">&#39;female&#39;</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">exam</span><span class="o">.</span><span class="n">patsex</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">exam</span><span class="o">.</span><span class="n">patsex</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="k">else</span> <span class="bp">None</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">psd_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">psdname</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="c"># self.scan_type = self._hdr.image.psd_iname.split(&#39;\0&#39;, 1)[0]  # XXX is this needed, it gets overwritten by end of fullparse</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">im_datetime</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">im_datetime</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>   <span class="c"># HOShims don&#39;t have self._hdr.image.im_datetime</span>
                <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">year</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">scan_date</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\0</span><span class="s">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">))</span>
                <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">scan_time</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\0</span><span class="s">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span> <span class="o">+</span> <span class="mi">1900</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">)</span>  <span class="c"># GE&#39;s epoch begins in 1900</span>

            <span class="c"># expose study date, study time, acquisition date, acquisition time</span>
            <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">year</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">scan_date</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\0</span><span class="s">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">))</span>
            <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">scan_time</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\0</span><span class="s">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">study_date</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%4d%02d%02d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">year</span> <span class="o">+</span> <span class="mi">1900</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">study_time</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%02d%02d%02d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">study_datetime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">study_date</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">study_time</span> <span class="ow">and</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">study_date</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">study_time</span><span class="p">[:</span><span class="mi">6</span><span class="p">],</span> <span class="s">&#39;%Y%m</span><span class="si">%d</span><span class="s">%H%M%S&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">im_datetime</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">acq_datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">im_datetime</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">acq_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acq_datetime</span><span class="p">,</span> <span class="s">&#39;%Y%m</span><span class="si">%d</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">acq_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acq_datetime</span><span class="p">,</span> <span class="s">&#39;%H%M%S&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">acq_datetime</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">acq_date</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">acq_time</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ti</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">ti</span> <span class="o">/</span> <span class="mf">1e6</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">te</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">te</span> <span class="o">/</span> <span class="mf">1e6</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">tr</span> <span class="o">/</span> <span class="mf">1e6</span>  <span class="c"># tr in seconds</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flip_angle</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">mr_flip</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pixel_bandwidth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">bw</span>
            <span class="c"># Note: the freq/phase dir isn&#39;t meaningful for spiral trajectories.</span>
            <span class="c"># GE numbers the dims 1,2, so freq_dir==1 is the first dim. We&#39;ll use</span>
            <span class="c"># the convention where first dim = 0, second dim = 1, etc. for phase_encode.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phase_encode</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">freq_dir</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mt_offset_hz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">offsetfreq</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">slquant</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_averages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">averages</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_echos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">nechoes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">receive_coil_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">cname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\0</span><span class="s">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_receivers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">dab</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stop_rcv</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">dab</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">start_rcv</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">operator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">exam</span><span class="o">.</span><span class="n">operator_new</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\0</span><span class="s">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">protocol_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">prtcl</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\0</span><span class="s">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scanner_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">exam</span><span class="o">.</span><span class="n">hospname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\0</span><span class="s">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">exam</span><span class="o">.</span><span class="n">ex_sysid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\0</span><span class="s">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scanner_type</span> <span class="o">=</span> <span class="s">&#39;GE MEDICAL SYSTEMS DISCOVERY MR750&#39;</span>    <span class="c"># FIXME: don&#39;t hardcode</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_type</span> <span class="o">=</span> <span class="bp">None</span>                                <span class="c"># hope this doesn&#39;t break anything...</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">dim_X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">dim_Y</span><span class="p">]</span>  <span class="c"># imatrix_Y</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fov</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">dfov</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">dfov_rect</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_bands</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_mux_cal_cycle</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">npasses</span>
            <span class="c"># Some sequences (e.g., muxepi) acuire more timepoints that will be available in the resulting data file.</span>
            <span class="c"># The following will indicate how many to expect in the final image.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints_available</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deltaTE</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale_data</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="c"># Compute the voxel size rather than use image.pixsize_X/Y</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mm_per_vox</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fov</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">fov</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">slthick</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">scanspacing</span><span class="p">]</span>
            <span class="n">image_tlhc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">tlhc_R</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">tlhc_A</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">tlhc_S</span><span class="p">])</span>
            <span class="n">image_trhc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">trhc_R</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">trhc_A</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">trhc_S</span><span class="p">])</span>
            <span class="n">image_brhc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">brhc_R</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">brhc_A</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">brhc_S</span><span class="p">])</span>

            <span class="c"># psd-specific params get set here</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">infer_psd_type</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_type</span> <span class="o">==</span> <span class="s">&#39;spiral&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">user0</span><span class="p">)</span>    <span class="c"># not in self._hdr.rec.nframes for sprt</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">deltaTE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">user15</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">band_spacing</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scale_data</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="c"># spiral is always a square encode based on the frequency encode direction (size_x)</span>
                <span class="c"># Atsushi also likes to round up to the next higher power of 2.</span>
                <span class="c"># self.size_x = int(pow(2,ceil(log2(pf.size_x))))</span>
                <span class="c"># The rec.im_size field seems to have the correct reconned image size, but</span>
                <span class="c"># this isn&#39;t guaranteed to be correct, as Atsushi&#39;s recon does whatever it</span>
                <span class="c"># damn well pleases. Maybe we could add a check to ninfer the image size,</span>
                <span class="c"># assuming it&#39;s square?</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">size_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">im_size</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mm_per_vox_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_per_vox_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fov_x</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_x</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_type</span> <span class="o">==</span> <span class="s">&#39;basic&#39;</span><span class="p">:</span>
                <span class="c"># first 6 are ref scans, so ignore those. Also, two acquired timepoints are used</span>
                <span class="c"># to generate each reconned time point.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">npasses</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">nechoes</span> <span class="o">-</span> <span class="mi">6</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_echos</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_type</span> <span class="o">==</span> <span class="s">&#39;muxepi&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_bands</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">user6</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_mux_cal_cycle</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">user7</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">band_spacing_mm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">user8</span>
                <span class="c"># When ARC is used with mux, the number of acquired TRs is greater than what&#39;s Rxed.</span>
                <span class="c"># ARC calibration uses multi-shot, so the additional TRs = num_bands*(ileaves-1)*num_mux_cal_cycle</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">npasses</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_bands</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">ileaves</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_mux_cal_cycle</span>
                <span class="c"># The actual number of images returned by the mux recon is npasses - num_calibration_passes + num_mux_cal_cycle</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints_available</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">npasses</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_bands</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_mux_cal_cycle</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_mux_cal_cycle</span>
                <span class="c"># TODO: adjust the image.tlhc... fields to match the correct geometry.</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_type</span> <span class="o">==</span> <span class="s">&#39;mrs&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">scanspacing</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mm_per_vox</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">roileny</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">roilenx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">roilenz</span><span class="p">]</span>
                <span class="n">image_tlhc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">roilocx</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_per_vox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">roilocy</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_per_vox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">roilocz</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_per_vox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span>
                <span class="n">image_trhc</span> <span class="o">=</span> <span class="n">image_tlhc</span> <span class="o">-</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mm_per_vox</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]</span>
                <span class="n">image_brhc</span> <span class="o">=</span> <span class="n">image_trhc</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_per_vox</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.</span><span class="p">]</span>
            <span class="c"># Tread carefully! Most of the stuff down here depends on various fields being corrected in the</span>
            <span class="c"># sequence-specific set of hacks just above. So, move things with care!</span>

            <span class="c"># Note: the following is true for single-shot planar acquisitions (EPI and 1-shot spiral).</span>
            <span class="c"># For multishot sequences, we need to multiply by the # of shots. And for non-planar aquisitions,</span>
            <span class="c"># we&#39;d need to multiply by the # of phase encodes (accounting for any acceleration factors).</span>
            <span class="c"># Even for planar sequences, this will be wrong (under-estimate) in case of cardiac-gating.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prescribed_duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tr</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">total_num_slices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints</span>
            <span class="c"># The actual duration can only be computed after the data are loaded. Settled for rx duration for now.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prescribed_duration</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">effective_echo_spacing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">effechospace</span> <span class="o">/</span> <span class="mf">1e6</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phase_encode_undersample</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">ileaves</span>
            <span class="c"># TODO: Set this correctly! (it&#39;s in the dicom at (0x0043, 0x1083))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slice_encode_undersample</span> <span class="o">=</span> <span class="mf">1.</span>          <span class="c"># FIXME</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_matrix_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_matrix_y</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">rc_xres</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">rc_yres</span><span class="p">]</span>
            <span class="c"># TODO: it looks like the pfile now has a &#39;grad_data&#39; field!</span>
            <span class="c"># Diffusion params</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dwi_numdirs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">numdifdirs</span>
            <span class="c"># You might think that the b-value for diffusion scans would be stored in self._hdr.image.b_value.</span>
            <span class="c"># But alas, this is GE. Apparently, that var stores the b-value of the just the first image, which is</span>
            <span class="c"># usually a non-dwi. So, we had to modify the PSD and stick the b-value into an rhuser CV. Sigh.</span>
            <span class="c"># NOTE: pre-dv24, the bvalue was stored in rec.user22.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dwi_bvalue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">user1</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="mi">24</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">user22</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_dwi</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dwi_numdirs</span> <span class="o">&gt;=</span> <span class="mi">6</span> <span class="k">else</span> <span class="bp">False</span>
            <span class="c"># if bit 4 of rhtype(int16) is set, then fractional NEX (i.e., partial ky acquisition) was used.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">partial_ky</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">scan_type</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="c"># was pepolar used to flip the phase encode direction?</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phase_encode_direction</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">dacq_ctrl</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">==</span><span class="mi">4</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">caipi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">user13</span>   <span class="c"># true: CAIPIRINHA-type acquisition; false: Direct aliasing of simultaneous slices.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cap_blip_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">user14</span>   <span class="c"># Starting index of the kz blips. 0~(mux-1) correspond to -kmax~kmax.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cap_blip_inc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">user15</span>   <span class="c"># Increment of the kz blip index for adjacent acquired ky lines.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mica</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">user17</span>   <span class="c"># MICA bit-reverse?</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slice_duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tr</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span>
            <span class="n">lr_diff</span> <span class="o">=</span> <span class="n">image_trhc</span> <span class="o">-</span> <span class="n">image_tlhc</span>
            <span class="n">si_diff</span> <span class="o">=</span> <span class="n">image_trhc</span> <span class="o">-</span> <span class="n">image_brhc</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">lr_diff</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">si_diff</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">row_cosines</span> <span class="o">=</span>  <span class="n">lr_diff</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lr_diff</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">lr_diff</span><span class="p">))</span>
                <span class="n">col_cosines</span> <span class="o">=</span> <span class="o">-</span><span class="n">si_diff</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">si_diff</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">si_diff</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">row_cosines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                <span class="n">col_cosines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slice_order</span> <span class="o">=</span> <span class="n">dcm</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">generic_mr</span><span class="o">.</span><span class="n">SLICE_ORDER_UNKNOWN</span>
            <span class="c"># FIXME: check that this is correct.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">se_sortorder</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">slice_order</span> <span class="o">=</span> <span class="n">dcm</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">generic_mr</span><span class="o">.</span><span class="n">SLICE_ORDER_SEQ_INC</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">se_sortorder</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">slice_order</span> <span class="o">=</span> <span class="n">dcm</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">generic_mr</span><span class="o">.</span><span class="n">SLICE_ORDER_ALT_INC</span>
            <span class="c"># header geometry is LPS, but we need RAS, so negate R and A.</span>
            <span class="n">slice_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">norm_R</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">norm_A</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">norm_S</span><span class="p">])</span>

            <span class="c"># This is either the first slice tlhc (image_tlhc) or the last slice tlhc. How to decide?</span>
            <span class="c"># And is it related to wheather I have to negate the slice_norm?</span>
            <span class="c"># Tuned this empirically by comparing spiral and EPI data with the same Rx.</span>
            <span class="c"># Everything seems reasonable, except the test for axial orientation (start_ras==S|I).</span>
            <span class="c"># I have no idea why I need that! But the flipping only seems necessary for axials, not</span>
            <span class="c"># coronals or the few obliques I&#39;ve tested.</span>
            <span class="c"># FIXME: haven&#39;t tested sagittals!</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">start_ras</span> <span class="ow">in</span> <span class="s">&#39;SI&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">start_loc</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">end_loc</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reverse_slice_order</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">slice_fov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">start_loc</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">end_loc</span><span class="p">)</span>
                <span class="n">image_position</span> <span class="o">=</span> <span class="n">image_tlhc</span> <span class="o">-</span> <span class="n">slice_norm</span> <span class="o">*</span> <span class="n">slice_fov</span>
                <span class="c"># FIXME: since we are reversing the slice order here, should we change the slice_order field below?</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">image_position</span> <span class="o">=</span> <span class="n">image_tlhc</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reverse_slice_order</span> <span class="o">=</span> <span class="bp">False</span>

            <span class="c"># not sure why the following is needed.</span>
            <span class="c"># TODO: * test non-slice-reversed coronals-- do they also need l/r flip?</span>
            <span class="c">#       * test sagitals-- do they need any flipping?</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">start_ras</span> <span class="ow">in</span> <span class="s">&#39;AP&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">start_loc</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">end_loc</span><span class="p">):</span>
                <span class="n">slice_norm</span> <span class="o">=</span> <span class="o">-</span><span class="n">slice_norm</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flip_lr</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flip_lr</span> <span class="o">=</span> <span class="bp">False</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_bands</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">image_position</span> <span class="o">=</span> <span class="n">image_position</span> <span class="o">-</span> <span class="n">slice_norm</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">band_spacing_mm</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_bands</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>

            <span class="c"># origin = image_position * np.array([-1, -1, 1])</span>
            <span class="c"># Fix the half-voxel offset. Apparently, the p-file convention specifies coords at the</span>
            <span class="c"># corner of a voxel. But DICOM/NIFTI convention is the voxel center. So offset by a half-voxel.</span>
            <span class="n">origin</span> <span class="o">=</span> <span class="n">image_position</span> <span class="o">+</span> <span class="p">(</span><span class="n">row_cosines</span><span class="o">+</span><span class="n">col_cosines</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mm_per_vox</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
            <span class="c"># The DICOM standard defines these two unit vectors in an LPS coordinate frame, but we&#39;ll</span>
            <span class="c"># need RAS (+x is right, +y is anterior, +z is superior) for NIFTI. So, we compute them</span>
            <span class="c"># such that self.row_cosines points to the right and self.col_cosines points up.</span>
            <span class="n">row_cosines</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">row_cosines</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">col_cosines</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">col_cosines</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dwi</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dwi_bvalue</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;the data appear to be diffusion-weighted, but image.b_value is 0! Setting it to 10.&#39;</span><span class="p">)</span>
                <span class="c"># Set it to something other than 0 so non-dwi&#39;s can be distinguised from dwi&#39;s</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dwi_bvalue</span> <span class="o">=</span> <span class="mf">10.</span>
            <span class="c"># The bvals/bvecs will get set later</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bvecs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bvals</span> <span class="o">=</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">diff_grad_scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">user34</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_rotation</span> <span class="o">=</span> <span class="n">dcm</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">generic_mr</span><span class="o">.</span><span class="n">compute_rotation</span><span class="p">(</span><span class="n">row_cosines</span><span class="p">,</span> <span class="n">col_cosines</span><span class="p">,</span> <span class="n">slice_norm</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qto_xyz</span> <span class="o">=</span> <span class="n">dcm</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">generic_mr</span><span class="o">.</span><span class="n">build_affine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_rotation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_per_vox</span><span class="p">,</span> <span class="n">origin</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">infer_psd_type</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">infer_scan_type</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">psd_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_type</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_type</span> <span class="o">==</span> <span class="s">&#39;muxepi&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_mux_cal_cycle</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">aux_file</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;muxepi without own calibration, will checking aux_file </span><span class="si">%s</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">aux_file</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;muxepi without own calibration. please provide an aux_file to load_data fxn.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">full_parsed</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata_status</span> <span class="o">=</span> <span class="s">&#39;complete&#39;</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="NIMSPFile.canonical_filename"><a class="viewcode-back" href="../../../nimsdata.html#nimsdata.medimg.nimspfile.NIMSPFile.canonical_filename">[docs]</a>    <span class="k">def</span> <span class="nf">canonical_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the pfile name, without .7.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfilename</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="NIMSPFile.priority"><a class="viewcode-back" href="../../../nimsdata.html#nimsdata.medimg.nimspfile.NIMSPFile.priority">[docs]</a>    <span class="k">def</span> <span class="nf">priority</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return priority, 1 if can recon, -1 if cannot.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">recon_func</span><span class="p">))</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c"># 1 = can recon, -1 = cannot</span>
</div>
<div class="viewcode-block" id="NIMSPFile.get_bvecs_bvals"><a class="viewcode-back" href="../../../nimsdata.html#nimsdata.medimg.nimspfile.NIMSPFile.get_bvecs_bvals">[docs]</a>    <span class="k">def</span> <span class="nf">get_bvecs_bvals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dirpath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse tensor data from tensor file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dirpath : str</span>
<span class="sd">            path to directory that contains tensor file.  This is usually the same directory that</span>
<span class="sd">            contains the P?????.7 file.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None : NoneType</span>
<span class="sd">            Set dataset.bvecs and dataset.bvals if tensor file is found.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tensor_name</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">.7_tensor.dat&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfilename</span>  <span class="c"># pfilename set during _full_parse</span>
        <span class="n">tensor_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">tensor_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tensor_path</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;tensor file </span><span class="si">%s</span><span class="s"> not found&#39;</span> <span class="o">%</span> <span class="n">tensor_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;tensor file </span><span class="si">%s</span><span class="s"> found&#39;</span> <span class="o">%</span> <span class="n">tensor_path</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tensor_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">uid</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
                    <span class="n">ndirs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="s">&#39;0&#39;</span> <span class="o">+</span> <span class="n">fp</span><span class="o">.</span><span class="n">readline</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">fp</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">uid</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="n">ndirs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="s">&#39;0&#39;</span> <span class="o">+</span> <span class="n">fp</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
                <span class="n">bvecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&#39; &#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">uid</span> <span class="ow">and</span> <span class="n">uid</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">series_uid</span><span class="p">:</span>  <span class="c"># uid provided does not match</span>
                <span class="k">raise</span> <span class="n">NIMSPFileError</span><span class="p">(</span><span class="s">&#39;tensor file UID does not match PFile UID!&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ndirs</span> <span class="ow">or</span> <span class="bp">None</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dwi_numdirs</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">dwi_numdirs</span> <span class="o">!=</span> <span class="n">bvecs</span><span class="o">.</span><span class="n">size</span> <span class="o">/</span> <span class="mf">3.</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;tensor file numdirs does not match PFile header numdirs!&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bvecs</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bvals</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">num_nondwi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints_available</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dwi_numdirs</span>
                <span class="n">bvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_nondwi</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dwi_bvalue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dwi_numdirs</span><span class="p">)))</span>
                <span class="n">bvecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">num_nondwi</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span> <span class="n">bvecs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dwi_numdirs</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bvecs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bvals</span> <span class="o">=</span> <span class="n">dcm</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">generic_mr</span><span class="o">.</span><span class="n">adjust_bvecs</span><span class="p">(</span><span class="n">bvecs</span><span class="p">,</span> <span class="n">bvals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanner_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_rotation</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="NIMSPFile.recon_func"><a class="viewcode-back" href="../../../nimsdata.html#nimsdata.medimg.nimspfile.NIMSPFile.recon_func">[docs]</a>    <span class="k">def</span> <span class="nf">recon_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Property that returns a member function that can then be executed.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_type</span> <span class="o">==</span> <span class="s">&#39;spiral&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">recon_spirec</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_type</span> <span class="o">==</span> <span class="s">&#39;muxepi&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">recon_muxepi</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_type</span> <span class="o">==</span> <span class="s">&#39;mrs&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">recon_mrs</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_type</span> <span class="o">==</span> <span class="s">&#39;hoshim&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">recon_hoshim</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_type</span> <span class="o">==</span> <span class="s">&#39;basic&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">recon_basic</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="NIMSPFile.do_recon"><a class="viewcode-back" href="../../../nimsdata.html#nimsdata.medimg.nimspfile.NIMSPFile.do_recon">[docs]</a>    <span class="k">def</span> <span class="nf">do_recon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tempdir</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run recon_func on filepath in the specified tempdir.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath : str</span>
<span class="sd">            path to pfile.7. input file must be pfile.7</span>
<span class="sd">        tempdir : str</span>
<span class="sd">            path to as base for temporary directory</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pfilepath</span> <span class="o">=</span> <span class="n">filepath</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span>
        <span class="n">pfiledir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">pfilepath</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dwi</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_bvecs_bvals</span><span class="p">(</span><span class="n">pfiledir</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">recon_func</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">recon_func</span><span class="p">(</span><span class="n">pfilepath</span><span class="p">,</span> <span class="n">tempdir</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;an error occured: pixel data could not be loaded from </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">failure_reason</span> <span class="o">=</span> <span class="n">e</span>

        <span class="c"># common stuff that can occur after the recon_func has been run, and data</span>
        <span class="c"># loaded into self.data, if a recon func was successfull, self.data will be a dict, instead of None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">():</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reverse_slice_order</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">][:,:,::</span><span class="o">-</span><span class="mi">1</span><span class="p">,]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">flip_lr</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">,:,:,]</span>
</div>
<div class="viewcode-block" id="NIMSPFile.load_data"><a class="viewcode-back" href="../../../nimsdata.html#nimsdata.medimg.nimspfile.NIMSPFile.load_data">[docs]</a>    <span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_jobs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">num_virtual_coils</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tempdir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">aux_file</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load the data and run the appropriate reconstruction.</span>

<span class="sd">        Load data always works on the __init__ filepath.  it will determine if the file is a tgz, or not, and</span>
<span class="sd">        take the appropriate action to fully parse and prepare to reconstruct.</span>

<span class="sd">        Some parameters are repeated from __init__, to allow resetting those parameters at the time of data load time.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        num_jobs : int</span>
<span class="sd">            override the number of jobs to use that was set during __init__</span>
<span class="sd">        num_virtual_coils : int</span>
<span class="sd">            override the number of virtual coils that was set during __init__</span>
<span class="sd">        tempdir : str</span>
<span class="sd">            override the temporary directory that was set during __init__</span>
<span class="sd">        aux_file : list</span>
<span class="sd">            override the list of potential aux files that was set during __init__</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_jobs</span> <span class="o">=</span> <span class="n">num_jobs</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_jobs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_vcoils</span> <span class="o">=</span> <span class="n">num_virtual_coils</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_vcoils</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aux_file</span> <span class="o">=</span> <span class="n">aux_file</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">aux_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span> <span class="o">=</span> <span class="n">tempdir</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span>

        <span class="k">if</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">is_tarfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;loading data from tgz </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_dirpath</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;now working in temp_dirpath=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">temp_dirpath</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">archive</span><span class="p">:</span>
                    <span class="n">archive</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">temp_dirpath</span><span class="p">)</span>

                <span class="n">temp_datadir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dirpath</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">temp_dirpath</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>    <span class="c"># tgz always has subdir that contains data</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">temp_datadir</span><span class="p">):</span>
                    <span class="n">fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_datadir</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">get_version</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_full_parse</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>  <span class="c"># provide input to parse</span>
                        <span class="k">break</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">do_recon</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="p">)</span>

            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;closing tempdir </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;loading data from .7 </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_parsed</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_full_parse</span><span class="p">()</span>      <span class="c"># parse original input</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_recon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NIMSPFile.load_imagedata_from_file"><a class="viewcode-back" href="../../../nimsdata.html#nimsdata.medimg.nimspfile.NIMSPFile.load_imagedata_from_file">[docs]</a>    <span class="k">def</span> <span class="nf">load_imagedata_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load raw image data from a file and do sanity checking on metadata values.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath : str</span>
<span class="sd">            path to *.mat, such as sl_001.mat</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        imagedata: np.array</span>
<span class="sd">            TODO: more details about np.array format?</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># TODO confirm that the voxel reordering is necessary</span>
        <span class="kn">import</span> <span class="nn">scipy.io</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;d&#39;</span> <span class="ow">in</span> <span class="n">mat</span><span class="p">:</span>
            <span class="n">sz</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="s">&#39;d_size&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">slice_locs</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="s">&#39;sl_loc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">imagedata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span> <span class="n">mat</span><span class="p">[</span><span class="s">&#39;d&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_3d</span><span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="s">&#39;d&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">slice_locs</span><span class="p">)</span><span class="o">&lt;</span><span class="n">raw</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">slice_locs</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">raw</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Slice_locs is too short. Assuming slice_locs=[0,1,...,nslices]&#39;</span><span class="p">)</span>
            <span class="n">imagedata</span><span class="p">[:,:,</span><span class="n">slice_locs</span><span class="p">,</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s">&#39;MIP_res&#39;</span> <span class="ow">in</span> <span class="n">mat</span><span class="p">:</span>
            <span class="n">imagedata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_3d</span><span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="s">&#39;MIP_res&#39;</span><span class="p">])</span>
            <span class="n">imagedata</span> <span class="o">=</span> <span class="n">imagedata</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,::</span><span class="o">-</span><span class="mi">1</span><span class="p">,:,:]</span>
        <span class="k">if</span> <span class="n">imagedata</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">imagedata</span> <span class="o">=</span> <span class="n">imagedata</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">imagedata</span><span class="o">.</span><span class="n">shape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,))</span>
        <span class="k">return</span> <span class="n">imagedata</span>
</div>
<div class="viewcode-block" id="NIMSPFile.update_imagedata"><a class="viewcode-back" href="../../../nimsdata.html#nimsdata.medimg.nimspfile.NIMSPFile.update_imagedata">[docs]</a>    <span class="k">def</span> <span class="nf">update_imagedata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imagedata</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Insert imagedata into self.data dictionary under the specified key.</span>

<span class="sd">        Update dataset metadata to be consistent with the imagedata.</span>

<span class="sd">        TODO: this assumes there is only a primary dataset. needs to rewritten for the</span>
<span class="sd">        case where there is primary and secondary data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        imagedata : array</span>
<span class="sd">            np array of voxel data</span>
<span class="sd">        key : str [default &#39;&#39;] (empty string is primary dataset)</span>
<span class="sd">            which key to use in data dict.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">imagedata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">imagedata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Image matrix discrepancy. Fixing the header, assuming imagedata is correct...&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="n">imagedata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">imagedata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mm_per_vox_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fov_x</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_y</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mm_per_vox_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fov_y</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_y</span>
        <span class="k">if</span> <span class="n">imagedata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_bands</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Image slice count discrepancy. Fixing the header, assuming imagedata is correct...&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span> <span class="o">=</span> <span class="n">imagedata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">imagedata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Image time frame discrepancy (header=</span><span class="si">%d</span><span class="s">, array=</span><span class="si">%d</span><span class="s">). Fixing the header, assuming imagedata is correct...&#39;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints</span><span class="p">,</span> <span class="n">imagedata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints</span> <span class="o">=</span> <span class="n">imagedata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tr</span> <span class="c"># FIXME: maybe need self.num_echos?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">imagedata</span><span class="p">}</span>
</div>
<div class="viewcode-block" id="NIMSPFile.recon_hoshim"><a class="viewcode-back" href="../../../nimsdata.html#nimsdata.medimg.nimspfile.NIMSPFile.recon_hoshim">[docs]</a>    <span class="k">def</span> <span class="nf">recon_hoshim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">tempdir</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;HOSHIM recon not implemented&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_non_image</span> <span class="o">=</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="NIMSPFile.recon_basic"><a class="viewcode-back" href="../../../nimsdata.html#nimsdata.medimg.nimspfile.NIMSPFile.recon_basic">[docs]</a>    <span class="k">def</span> <span class="nf">recon_basic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">tempdir</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;BASIC recon not implemented&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_non_image</span> <span class="o">=</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="NIMSPFile.recon_spirec"><a class="viewcode-back" href="../../../nimsdata.html#nimsdata.medimg.nimspfile.NIMSPFile.recon_spirec">[docs]</a>    <span class="k">def</span> <span class="nf">recon_spirec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">tempdir</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run spirec recon on the input filepath.</span>

<span class="sd">        Requires access to the spiral_recon submodule.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath : str</span>
<span class="sd">            path to P?????.7 to be reconstructed as spiral</span>
<span class="sd">        tempdir : str</span>
<span class="sd">            path to base of temporary directory</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;SPIREC recon started&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">tempdir</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_dirpath</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;working in tempdir: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">temp_dirpath</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is_gzip</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
                <span class="n">pfile_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dirpath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pfile_path</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">gzfile</span><span class="p">:</span>
                        <span class="n">fd</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">gzfile</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pfile_path</span> <span class="o">=</span> <span class="n">filepath</span>
            <span class="n">recon_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="s">&#39;spiral_recon&#39;</span><span class="p">))</span>
            <span class="n">basepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dirpath</span><span class="p">,</span> <span class="s">&#39;recon&#39;</span><span class="p">)</span>
            <span class="n">spirec_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">recon_path</span><span class="p">,</span> <span class="s">&#39;spirec&#39;</span><span class="p">)</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> -l --rotate -90 --magfile --savefmap2 --b0navigator -r </span><span class="si">%s</span><span class="s"> -t </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">spirec_path</span><span class="p">,</span> <span class="n">pfile_path</span><span class="p">,</span> <span class="n">basepath</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">cwd</span><span class="o">=</span><span class="n">temp_dirpath</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s">&#39;/dev/null&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">))</span>  <span class="c"># run spirec to generate .mag and fieldmap files</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">temp_dirpath</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">basepath</span><span class="o">+</span><span class="s">&#39;.mag_float&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timepoints</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">num_echos</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span><span class="p">],</span><span class="n">order</span><span class="o">=</span><span class="s">&#39;F&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))}</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">basepath</span><span class="o">+</span><span class="s">&#39;.B0freq2&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">basepath</span><span class="o">+</span><span class="s">&#39;.B0freq2&#39;</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;fieldmap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">basepath</span><span class="o">+</span><span class="s">&#39;.B0freq2&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">num_echos</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span><span class="p">],</span><span class="n">order</span><span class="o">=</span><span class="s">&#39;F&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_echos</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c"># FIXME: Do a more robust test for spiralio!</span>
                <span class="c"># FIXME: should do a quick motion correction here</span>
                <span class="c"># Assume spiralio, so do a weighted average of the two echos.</span>
                <span class="n">w_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">][:,:,:,:,</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">w_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">][:,:,:,:,</span><span class="mi">1</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>
                <span class="c"># self.data[&#39;w_in&#39;] = w_in    # uncomment to save spiral_in</span>
                <span class="c"># self.data[&#39;w_out&#39;] = w_out  # uncomment to save spiral_out</span>
                <span class="n">inout_sum</span> <span class="o">=</span> <span class="n">w_in</span> <span class="o">+</span> <span class="n">w_out</span>
                <span class="n">w_in</span> <span class="o">=</span> <span class="n">w_in</span> <span class="o">/</span> <span class="n">inout_sum</span>
                <span class="n">w_out</span> <span class="o">=</span> <span class="n">w_out</span> <span class="o">/</span> <span class="n">inout_sum</span>
                <span class="n">avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                    <span class="n">avg</span><span class="p">[:,:,:,</span><span class="n">tp</span><span class="p">]</span> <span class="o">=</span> <span class="n">w_in</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">][:,:,:,</span><span class="n">tp</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">w_out</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">][:,:,:,</span><span class="n">tp</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">avg</span>
</div>
<div class="viewcode-block" id="NIMSPFile.prep_convert"><a class="viewcode-back" href="../../../nimsdata.html#nimsdata.medimg.nimspfile.NIMSPFile.prep_convert">[docs]</a>    <span class="k">def</span> <span class="nf">prep_convert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return criteria for identifying the additional aux file necessary to perform recon.</span>

<span class="sd">        This gives the processor a way of checking if additional files are necessary.  The processor has some knowledge about</span>
<span class="sd">        muxepi and how to identify a valid aux file.</span>

<span class="sd">        The main business logic of identifying candidate aux files has been moved into processor.py.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># FIXME: the following is a hack to get mux_epi2 SE-IR scans to recon properly. There *is* a more generic solution...</span>
        <span class="c"># some mux scans don&#39;t have their own calibration, and require fetching calibration a scan with the same psd_name.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_type</span><span class="o">==</span><span class="s">&#39;muxepi&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_mux_cal_cycle</span><span class="o">&lt;</span><span class="mi">2</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psd_name</span><span class="o">==</span><span class="s">&#39;mux_epi2&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ti</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)):</span>
            <span class="n">aux_data</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;psd&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_name</span> <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">aux_data</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">aux_data</span>
</div>
<div class="viewcode-block" id="NIMSPFile.recon_muxepi"><a class="viewcode-back" href="../../../nimsdata.html#nimsdata.medimg.nimspfile.NIMSPFile.recon_muxepi">[docs]</a>    <span class="k">def</span> <span class="nf">recon_muxepi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">tempdir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">timepoints</span><span class="o">=</span><span class="p">[],</span> <span class="n">octave_bin</span><span class="o">=</span><span class="s">&#39;octave&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Do mux_epi image reconstruction and populate self.data.</span>

<span class="sd">        Always involves a tempdir.  If input is a pfile.tgz, the tempdir was created during</span>
<span class="sd">        unpacking will be re-used during recon. If input is a pfile.7, then the temp during</span>
<span class="sd">        will be created during this recon.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath : str</span>
<span class="sd">            input P?????.7 to be reconstructed</span>
<span class="sd">        tempdir : str</span>
<span class="sd">            path to base temporary directory</span>
<span class="sd">        timepoints : list</span>
<span class="sd">            if list is non-empty, restrict reconstruction to the listed timepoints</span>
<span class="sd">        octave_bin : str [default &#39;octave&#39;]</span>
<span class="sd">            path to octave executable, default assumes octave can be found in $PATH</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start_sec</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;MUXEPI recon of </span><span class="si">%s</span><span class="s"> started at </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">start_sec</span><span class="p">))</span>
        <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="n">dirpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">recon_type</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
            <span class="c"># set the recon type automatically</span>
            <span class="c"># Scans with mux&gt;1, arc&gt;1, caipi</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dwi</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_bands</span><span class="o">&gt;</span><span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_encode_undersample</span><span class="o">&lt;</span><span class="mf">1.</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">caipi</span><span class="p">:</span>
                <span class="n">recon_type</span> <span class="o">=</span> <span class="s">&#39;sense&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">recon_type</span> <span class="o">=</span> <span class="s">&#39;1dgrappa&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">recon_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recon_type</span>

        <span class="n">fermi_filt</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">homodyne</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aux_file</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">tempdir</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_dirpath</span><span class="p">:</span>
            <span class="c"># identification and extraction of the aux file has been moved into tempdir context manager</span>
            <span class="c"># to allow extraction of the valid vrgf and ref within tempdir.</span>
            <span class="c"># cal file must be either &#39;&#39;, or dir/basename that is similar between ref.dat and vrgf.dat</span>
            <span class="n">cal_file</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>  <span class="c"># XXX matlab/octave, base path determine names of ref.dat and vrgf.dat</span>
            <span class="n">ref_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">basename</span> <span class="o">+</span> <span class="s">&#39;_ref.dat&#39;</span><span class="p">)</span>
            <span class="n">vrgf_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">basename</span> <span class="o">+</span> <span class="s">&#39;_vrgf.dat&#39;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;checking num_mux_cal_cycle: </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_mux_cal_cycle</span><span class="p">)</span>
            <span class="c"># matlab code checks for num_mux_cal_cycles, so why don&#39;t we check the same thing</span>
            <span class="c"># even scans without num_mux_cal_cycles will still have ref/vrgf files that exceed 64 bytes</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_mux_cal_cycle</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;num_mux_cal_cycle: </span><span class="si">%d</span><span class="s">. looking for calibration from a different acq.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_mux_cal_cycle</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">aux_file</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aux_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">aux_archive</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;inspecting aux file: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">aux_file</span><span class="p">)</span>
                        <span class="n">aux_archive</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">temp_dirpath</span><span class="p">)</span>
                    <span class="n">aux_subdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">temp_dirpath</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">aux_datadir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dirpath</span><span class="p">,</span> <span class="n">aux_subdir</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">aux_datadir</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;_ref.dat&#39;</span><span class="p">):</span>
                            <span class="n">cal_ref_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">aux_datadir</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;_ref.dat found, </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">cal_ref_file</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;_vrgf.dat&#39;</span><span class="p">):</span>
                            <span class="n">cal_vrgf_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">aux_datadir</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;_vrgf.dat found, </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">cal_vrgf_file</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">pass</span>
                <span class="k">if</span> <span class="n">cal_ref_file</span> <span class="ow">and</span> <span class="n">cal_vrgf_file</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">cal_ref_file</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">cal_vrgf_file</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">cal_file</span> <span class="o">=</span> <span class="n">cal_ref_file</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;ref/vrgf.dat not found-- using calibration ref/vrgf from </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">aux_file</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">NIMSPFileError</span><span class="p">(</span><span class="s">&#39;ref.dat/vrgf.dat not found&#39;</span><span class="p">)</span>

            <span class="c"># run the actual recon, spawning subprocess until all slices have been spawned.</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Running </span><span class="si">%d</span><span class="s"> v-coil mux recon on </span><span class="si">%s</span><span class="s"> in tempdir </span><span class="si">%s</span><span class="s"> with </span><span class="si">%d</span><span class="s"> jobs (recon=</span><span class="si">%s</span><span class="s">, fermi=</span><span class="si">%d</span><span class="s">, homodyne=</span><span class="si">%d</span><span class="s">, notch=</span><span class="si">%f</span><span class="s">).&#39;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_vcoils</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">temp_dirpath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_jobs</span><span class="p">,</span> <span class="n">recon_type</span><span class="p">,</span> <span class="n">fermi_filt</span><span class="p">,</span> <span class="n">homodyne</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">notch_thresh</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">cal_file</span><span class="o">!=</span><span class="s">&#39;&#39;</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Using calibration file: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">cal_file</span><span class="p">)</span>
            <span class="n">recon_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="s">&#39;mux_epi_recon&#39;</span><span class="p">))</span>
            <span class="n">outname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dirpath</span><span class="p">,</span> <span class="s">&#39;sl&#39;</span><span class="p">)</span>

            <span class="n">mux_recon_jobs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">slice_num</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">slice_num</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span><span class="p">:</span>
                <span class="n">num_running_jobs</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">job</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span><span class="o">==</span><span class="bp">None</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">mux_recon_jobs</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">num_running_jobs</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_jobs</span><span class="p">:</span>
                    <span class="c"># Recon each slice separately. Note the slice_num+1 to deal with matlab&#39;s 1-indexing.</span>
                    <span class="c"># Use &#39;str&#39; on timepoints so that an empty array will produce &#39;[]&#39;</span>
                    <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> --no-window-system -p </span><span class="si">%s</span><span class="s"> --eval </span><span class="se">\&#39;</span><span class="s">mux_epi_main(&quot;</span><span class="si">%s</span><span class="s">&quot;, &quot;</span><span class="si">%s</span><span class="s">_</span><span class="si">%03d</span><span class="s">.mat&quot;, &quot;</span><span class="si">%s</span><span class="s">&quot;, </span><span class="si">%d</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%d</span><span class="s">, 0, &quot;</span><span class="si">%s</span><span class="s">&quot;, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">);</span><span class="se">\&#39;</span><span class="s">&#39;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">octave_bin</span><span class="p">,</span> <span class="n">recon_path</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">outname</span><span class="p">,</span> <span class="n">slice_num</span><span class="p">,</span> <span class="n">cal_file</span><span class="p">,</span> <span class="n">slice_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">timepoints</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_vcoils</span><span class="p">,</span> <span class="n">recon_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">fermi_filt</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">homodyne</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">notch_thresh</span><span class="p">)))</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
                    <span class="n">mux_recon_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">stdout</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s">&#39;/dev/null&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)))</span>
                    <span class="n">slice_num</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.</span><span class="p">)</span>

            <span class="c"># Now wait for all the jobs to finish</span>
            <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">mux_recon_jobs</span><span class="p">:</span>
                <span class="n">job</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

            <span class="c"># Load the first slice to initialize the image array</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_imagedata_from_file</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">_</span><span class="si">%03d</span><span class="s">.mat&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">outname</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">slice_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span><span class="p">):</span>
                <span class="n">new_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_imagedata_from_file</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">_</span><span class="si">%03d</span><span class="s">.mat&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">outname</span><span class="p">,</span> <span class="n">slice_num</span><span class="p">))</span>
                <span class="c"># Allow for a partial last timepoint. This sometimes happens when the user aborts.</span>
                <span class="n">t</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">new_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">t</span><span class="p">]</span> <span class="o">+=</span> <span class="n">new_img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">t</span><span class="p">]</span>

            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_imagedata</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
            <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_sec</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Mux recon of </span><span class="si">%s</span><span class="s"> with </span><span class="si">%d</span><span class="s"> v-coils finished in </span><span class="si">%0.2f</span><span class="s"> minutes using </span><span class="si">%d</span><span class="s"> jobs.&#39;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_vcoils</span><span class="p">,</span>  <span class="n">elapsed</span><span class="o">/</span><span class="mf">60.</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_jobs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span><span class="p">)))</span>
</div>
<div class="viewcode-block" id="NIMSPFile.recon_mrs"><a class="viewcode-back" href="../../../nimsdata.html#nimsdata.medimg.nimspfile.NIMSPFile.recon_mrs">[docs]</a>    <span class="k">def</span> <span class="nf">recon_mrs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">tempdir</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load raw spectro data.</span>

<span class="sd">        Currently just loads raw spectro data into self.data dictionary, to</span>
<span class="sd">        prepare for writing to nifti.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath : str</span>
<span class="sd">            path to input file, can be .7, .7.gz.  cannot be 7.tgz.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None : NoneType</span>
<span class="sd">            loads spectro data into self.data[&#39;&#39;]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;MRS recon started&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rawdata</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">])}</span>
</div>
<div class="viewcode-block" id="NIMSPFile.get_rawdata"><a class="viewcode-back" href="../../../nimsdata.html#nimsdata.medimg.nimspfile.NIMSPFile.get_rawdata">[docs]</a>    <span class="k">def</span> <span class="nf">get_rawdata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">slices</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">passes</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">coils</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">echos</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read and return a chunck of data from the p-file.</span>

<span class="sd">        Specify the slices, timepoints, coils, and echos that you want.</span>
<span class="sd">        None means you get all of them. The default of all Nones will</span>
<span class="sd">        return all data.</span>
<span class="sd">        (based on https://github.com/cni/MRS/blob/master/MRS/files.py)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">nframes</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">hnover</span>
        <span class="n">n_echos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">nechoes</span>
        <span class="n">n_slices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">nslices</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">npasses</span>
        <span class="n">n_coils</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_receivers</span>
        <span class="n">n_passes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">npasses</span>
        <span class="n">frame_sz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">frame_size</span>

        <span class="k">if</span> <span class="n">passes</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span> <span class="n">passes</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_passes</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">coils</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span> <span class="n">coils</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_coils</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">slices</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span> <span class="n">slices</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_slices</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">echos</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span> <span class="n">echos</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_echos</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">frames</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span> <span class="n">frames</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_frames</span><span class="p">)</span>

        <span class="c"># Size (in bytes) of each sample:</span>
        <span class="n">ptsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">point_size</span>
        <span class="n">data_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">][</span><span class="n">ptsize</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c"># This is double the size as above, because the data is complex:</span>
        <span class="n">frame_bytes</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ptsize</span> <span class="o">*</span> <span class="n">frame_sz</span>

        <span class="n">echosz</span> <span class="o">=</span> <span class="n">frame_bytes</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">n_frames</span><span class="p">)</span>
        <span class="n">slicesz</span> <span class="o">=</span> <span class="n">echosz</span> <span class="o">*</span> <span class="n">n_echos</span>
        <span class="n">coilsz</span> <span class="o">=</span> <span class="n">slicesz</span> <span class="o">*</span> <span class="n">n_slices</span>
        <span class="n">passsz</span> <span class="o">=</span> <span class="n">coilsz</span> <span class="o">*</span> <span class="n">n_coils</span>

        <span class="c"># Byte-offset to get to the data:</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">off_data</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_gzip</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">else</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">frame_sz</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">frames</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">echos</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">slices</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">coils</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">passes</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pi</span><span class="p">,</span><span class="n">passidx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">passes</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ci</span><span class="p">,</span><span class="n">coilidx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coils</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">si</span><span class="p">,</span><span class="n">sliceidx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">slices</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">ei</span><span class="p">,</span><span class="n">echoidx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">echos</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">fi</span><span class="p">,</span><span class="n">frameidx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">frames</span><span class="p">):</span>
                            <span class="n">fp</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">passidx</span><span class="o">*</span><span class="n">passsz</span> <span class="o">+</span> <span class="n">coilidx</span><span class="o">*</span><span class="n">coilsz</span> <span class="o">+</span> <span class="n">sliceidx</span><span class="o">*</span><span class="n">slicesz</span> <span class="o">+</span> <span class="n">echoidx</span><span class="o">*</span><span class="n">echosz</span> <span class="o">+</span> <span class="p">(</span><span class="n">frameidx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">frame_bytes</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span>
                            <span class="c"># Unfortunately, numpy fromfile doesn&#39;t like gzip file objects. But we can</span>
                            <span class="c"># safely load each chunk into RAM, since frame_sz is never very big.</span>
                            <span class="c">#dr = np.fromfile(fp, data_type, frame_sz * 2)</span>
                            <span class="n">dr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">frame_bytes</span><span class="p">),</span> <span class="n">data_type</span><span class="p">)</span>
                            <span class="n">dr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">dr</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
                            <span class="n">data</span><span class="p">[:,</span> <span class="n">fi</span><span class="p">,</span> <span class="n">ei</span><span class="p">,</span> <span class="n">si</span><span class="p">,</span> <span class="n">ci</span><span class="p">,</span> <span class="n">pi</span><span class="p">]</span> <span class="o">=</span> <span class="n">dr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">1j</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">data</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">NIMSData  documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, Author.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>
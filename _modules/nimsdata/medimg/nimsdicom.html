<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>nimsdata.medimg.nimsdicom &mdash; NIMSData  documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="NIMSData  documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">NIMSData  documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for nimsdata.medimg.nimsdicom</h1><div class="highlight"><pre>
<span class="c"># @author:  Gunnar Schaefer</span>
<span class="c">#           Bob Dougherty</span>
<span class="c">#           Kevin S Hahn</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">nimsdata.medimg.nimsdicom</span>
<span class="sd">=========================</span>

<span class="sd">nimsdicom stuff, and adds dicom specific parsing routines.</span>
<span class="sd">nimsdicom uses a composer design pattern to dynamically incoporate functions based on</span>
<span class="sd">the input data.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">dicom</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">dcmstack</span>
<span class="kn">import</span> <span class="nn">cStringIO</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">dcmstack.extract</span>
<span class="kn">import</span> <span class="nn">nibabel.nicom.csareader</span>

<span class="kn">import</span> <span class="nn">medimg</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>


<span class="n">dicom</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">auto_convert_VR_mismatch</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">nibabel</span><span class="o">.</span><span class="n">nicom</span><span class="o">.</span><span class="n">csareader</span><span class="o">.</span><span class="n">MAX_CSA_ITEMS</span> <span class="o">=</span> <span class="mi">300</span>
<span class="n">dcmstack</span><span class="o">.</span><span class="n">DicomStack</span><span class="o">.</span><span class="n">sort_guesses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;CsaImage.ImaCoilString&#39;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">dcmstack</span><span class="o">.</span><span class="n">DicomStack</span><span class="o">.</span><span class="n">sort_guesses</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s">&#39;InversionTime&#39;</span><span class="p">)</span>
    <span class="n">dcmstack</span><span class="o">.</span><span class="n">DicomStack</span><span class="o">.</span><span class="n">minimal_keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s">&#39;PixelSpacing&#39;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="n">MAX_LOC_DCMS</span> <span class="o">=</span> <span class="mi">150</span>  <span class="c"># maximum number of dicoms allowed in a &quot;localizer&quot;</span>

<span class="n">SUPPORTED_MFR</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;GE MEDICAL SYSTEMS&#39;</span><span class="p">:</span> <span class="s">&#39;ge&#39;</span><span class="p">,</span>
    <span class="s">&#39;SIEMENS&#39;</span><span class="p">:</span> <span class="s">&#39;siemens&#39;</span><span class="p">,</span>
    <span class="p">}</span>
<span class="n">SUPPORTED_SOP</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;1.2.840.10008.5.1.4.1.1.4&#39;</span><span class="p">:</span> <span class="s">&#39;mr&#39;</span><span class="p">,</span>  <span class="c"># MR Image</span>
    <span class="s">&#39;1.2.840.10008.5.1.4.1.1.7&#39;</span><span class="p">:</span> <span class="s">&#39;sc&#39;</span><span class="p">,</span>  <span class="c"># Secondary Capture</span>
    <span class="s">&#39;1.3.12.2.1107.5.9.1&#39;</span><span class="p">:</span> <span class="s">&#39;syngo_csa&#39;</span><span class="p">,</span>  <span class="c"># Private Syngo CSA Non-Image; SIEMENS ONLY</span>
    <span class="s">&#39;1.2.840.10008.5.1.4.1.1.88.22&#39;</span><span class="p">:</span> <span class="s">&#39;enhanced_sr&#39;</span><span class="p">,</span>
    <span class="s">&#39;1.2.840.10008.5.1.4.1.1.128&#39;</span><span class="p">:</span> <span class="s">&#39;pet&#39;</span><span class="p">,</span>
    <span class="c"># &#39;1.2.840.10008.5.1.4.1.1.130&#39;: &#39;enhanced_pet&#39;,</span>
    <span class="c"># &#39;1.2.840.10008.5.1.4.1.1.128.1&#39;: &#39;legacy_enhanced_pet&#39;,</span>
    <span class="p">}</span>


<span class="c"># XXX; not compatible with dcmstack.extract.MetaExtractor warn_on_ex parameter.</span>
<span class="c"># catching the error prevents error from getting to MetaExtractor class where</span>
<span class="c"># it was being converted to a warning.</span>
<span class="c"># this change is necessary because some of the DTI from Davis and UI have a badly</span>
<span class="c"># formed header field.  The raised exception prevents the remaining</span>
<span class="c"># sections of mr phoenix protocol to not get parsed.</span>
<span class="c"># this problem is located in Csa Series Header, &#39;sWiPMemBlock.tFree&#39;</span>
<div class="viewcode-block" id="Extractor"><a class="viewcode-back" href="../../../nimsdata.html#nimsdata.medimg.nimsdicom.Extractor">[docs]</a><span class="k">class</span> <span class="nc">Extractor</span><span class="p">(</span><span class="n">dcmstack</span><span class="o">.</span><span class="n">extract</span><span class="o">.</span><span class="n">MetaExtractor</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Override the default dcmstack.extract.MetaExtractor.</span>

<span class="sd">    If an elements value cannot be translated using the supplied Value Representation (VR),</span>
<span class="sd">    then return an empty string.  dcmstack.extract.MetaExtractor would normally raise a ValueError</span>
<span class="sd">    upon value-VR mismatch.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_get_elem_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elem</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the value for any non-translated elements.</span>

<span class="sd">        If element is not translateable with its own VR, then return value=None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Extractor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_get_elem_value</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">return</span> <span class="n">value</span>

</div>
<span class="k">def</span> <span class="nf">_parse_phoenix_prot</span><span class="p">(</span><span class="n">prot_key</span><span class="p">,</span> <span class="n">prot_val</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse a siemens MrProtocol or MrPhoenixProtocol string.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">prot_key</span> <span class="o">==</span> <span class="s">&#39;MrPhoenixProtocol&#39;</span><span class="p">:</span>         <span class="c"># syngo B</span>
        <span class="n">str_delim</span> <span class="o">=</span> <span class="s">&#39;&quot;&quot;&#39;</span>
    <span class="k">elif</span> <span class="n">prot_key</span> <span class="o">==</span> <span class="s">&#39;MrProtocol&#39;</span><span class="p">:</span>              <span class="c"># syngo A</span>
        <span class="n">str_delim</span> <span class="o">=</span> <span class="s">&#39;&quot;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Unknown protocol key: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">prot_key</span><span class="p">)</span>
    <span class="n">ascconv_start</span> <span class="o">=</span> <span class="n">prot_val</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;### ASCCONV BEGIN ###&#39;</span><span class="p">)</span>
    <span class="n">ascconv_end</span> <span class="o">=</span> <span class="n">prot_val</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;### ASCCONV END ###&#39;</span><span class="p">)</span>
    <span class="n">ascconv</span> <span class="o">=</span> <span class="n">prot_val</span><span class="p">[</span><span class="n">ascconv_start</span><span class="p">:</span><span class="n">ascconv_end</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">ascconv</span><span class="p">:</span>
        <span class="c"># added try except. does not stop parsing when exception is raised.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">parse_result</span> <span class="o">=</span> <span class="n">dcmstack</span><span class="o">.</span><span class="n">extract</span><span class="o">.</span><span class="n">_parse_phoenix_line</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">str_delim</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>       <span class="c"># TODO: specific exception?</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;error parsing line </span><span class="si">%s</span><span class="s">...&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">line</span><span class="p">[:</span><span class="mi">20</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">parse_result</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">parse_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">parse_result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">_csa_series_trans_func</span><span class="p">(</span><span class="n">elem</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function for parsing the CSA series sub header element by element.&quot;&quot;&quot;</span>
    <span class="n">csa_dict</span> <span class="o">=</span> <span class="n">dcmstack</span><span class="o">.</span><span class="n">extract</span><span class="o">.</span><span class="n">simplify_csa_dict</span><span class="p">(</span><span class="n">nibabel</span><span class="o">.</span><span class="n">nicom</span><span class="o">.</span><span class="n">csareader</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
    <span class="c"># If there is a phoenix protocol, parse it and dump it into the csa_dict</span>
    <span class="n">phx_src</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="s">&#39;MrPhoenixProtocol&#39;</span> <span class="ow">in</span> <span class="n">csa_dict</span><span class="p">:</span>
        <span class="n">phx_src</span> <span class="o">=</span> <span class="s">&#39;MrPhoenixProtocol&#39;</span>
    <span class="k">elif</span> <span class="s">&#39;MrProtocol&#39;</span> <span class="ow">in</span> <span class="n">csa_dict</span><span class="p">:</span>
        <span class="n">phx_src</span> <span class="o">=</span> <span class="s">&#39;MrProtocol&#39;</span>
    <span class="k">if</span> <span class="n">phx_src</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">phoenix_dict</span> <span class="o">=</span> <span class="n">_parse_phoenix_prot</span><span class="p">(</span><span class="n">phx_src</span><span class="p">,</span> <span class="n">csa_dict</span><span class="p">[</span><span class="n">phx_src</span><span class="p">])</span>  <span class="c"># calls custom _parse_phoenix_prot</span>
        <span class="k">del</span> <span class="n">csa_dict</span><span class="p">[</span><span class="n">phx_src</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">phoenix_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">new_key</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;MrPhoenixProtocol&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="n">csa_dict</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
    <span class="k">return</span> <span class="n">csa_dict</span>


<span class="k">def</span> <span class="nf">_simplify_csa_dict</span><span class="p">(</span><span class="n">csa_dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simplify the result of nibabel.nicom.csareader and normalize list content types.</span>

<span class="sd">    dcmstack.extract.csa_dict naively inserts values into the result without attempting</span>
<span class="sd">    to normalize list item types.  For example, if a value is a list, and contains mixed</span>
<span class="sd">    string and unicode types, the value will contain mixed string and unicode types. If the first</span>
<span class="sd">    item in the list is a string, and the remaining are unicode, dcmstack.extract.MetaExtractor.__call__</span>
<span class="sd">    will attempt to cast all values as unicode(in_str, &#39;utf-8&#39;), which will raise exception.</span>

<span class="sd">    By converting all list items that are strings to unicode, the first list item will be recognized</span>
<span class="sd">    as unicode, and the second round (MetaExtactor.__call__) of unicode conversion will be skipped.</span>

<span class="sd">    Alternatively, could convert all list items that are unicode to string.  In this case, the first</span>
<span class="sd">    list item would be recognized as a str, and the second round unicode conversion</span>
<span class="sd">    (MetaExtractor.__call__) should succeeed.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">csa_dict</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">csa_dict</span><span class="p">[</span><span class="s">&#39;tags&#39;</span><span class="p">]:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">csa_dict</span><span class="p">[</span><span class="s">&#39;tags&#39;</span><span class="p">][</span><span class="n">tag</span><span class="p">][</span><span class="s">&#39;items&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># convert any strings to unicode,</span>
            <span class="n">result</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">unicode</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">items</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">_csa_image_trans_func</span><span class="p">(</span><span class="n">elem</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_simplify_csa_dict</span><span class="p">(</span><span class="n">nibabel</span><span class="o">.</span><span class="n">nicom</span><span class="o">.</span><span class="n">csareader</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>

<span class="n">_csa_series_trans</span> <span class="o">=</span> <span class="n">dcmstack</span><span class="o">.</span><span class="n">extract</span><span class="o">.</span><span class="n">Translator</span><span class="p">(</span>
        <span class="s">&#39;CsaSeries&#39;</span><span class="p">,</span>
        <span class="n">dicom</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">Tag</span><span class="p">(</span><span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x1020</span><span class="p">),</span>
        <span class="s">&#39;SIEMENS CSA HEADER&#39;</span><span class="p">,</span>
        <span class="n">_csa_series_trans_func</span><span class="p">)</span>

<span class="n">_csa_image_trans</span> <span class="o">=</span> <span class="n">dcmstack</span><span class="o">.</span><span class="n">extract</span><span class="o">.</span><span class="n">Translator</span><span class="p">(</span>
        <span class="s">&#39;CsaImage&#39;</span><span class="p">,</span>
        <span class="n">dicom</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">Tag</span><span class="p">(</span><span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x1010</span><span class="p">),</span>
        <span class="s">&#39;SIEMENS CSA HEADER&#39;</span><span class="p">,</span>
        <span class="n">_csa_image_trans_func</span><span class="p">)</span>

<span class="n">MetaExtractor</span> <span class="o">=</span> <span class="n">Extractor</span><span class="p">(</span>
        <span class="n">ignore_rules</span><span class="o">=</span><span class="p">[</span><span class="n">dcmstack</span><span class="o">.</span><span class="n">extract</span><span class="o">.</span><span class="n">ignore_non_ascii_bytes</span><span class="p">],</span>
        <span class="n">translators</span><span class="o">=</span><span class="p">[</span><span class="n">_csa_image_trans</span><span class="p">,</span> <span class="n">_csa_series_trans</span><span class="p">]</span>
        <span class="p">)</span>


<div class="viewcode-block" id="NIMSDicomError"><a class="viewcode-back" href="../../../nimsdata.html#nimsdata.medimg.nimsdicom.NIMSDicomError">[docs]</a><span class="k">class</span> <span class="nc">NIMSDicomError</span><span class="p">(</span><span class="n">medimg</span><span class="o">.</span><span class="n">MedImgError</span><span class="p">):</span>
    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="NIMSDicom"><a class="viewcode-back" href="../../../nimsdata.html#nimsdata.medimg.nimsdicom.NIMSDicom">[docs]</a><span class="k">class</span> <span class="nc">NIMSDicom</span><span class="p">(</span><span class="n">medimg</span><span class="o">.</span><span class="n">MedImgReader</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse a series of Dicoms.</span>

<span class="sd">    if load_data is set to True, the load_data method will be called at the end of init. scan identification</span>
<span class="sd">    is done during load_data. although some types can be determined with minimal data, identification is</span>
<span class="sd">    done at the same place across venders to provide consistency.</span>

<span class="sd">    parse gives a ball park idea of &quot;what it is,&quot; without loading everything.</span>

<span class="sd">    NIMSDicom is a special composer class.  Upon instantiation, NIMSDicom evaluates the input</span>
<span class="sd">    file to determine it&#39;s image type, manufactuere and SOP class.  Using that information, NIMSDicom</span>
<span class="sd">    imports the appropriate group of functions, and assigns each function as a member to itself.</span>

<span class="sd">    NIMSDicom will initally parse the SOP Class UID, image type, and manufacturer, to determine</span>
<span class="sd">    what parsing needs to be done.  NIMSDicom will compose itself by selecting functions that are</span>
<span class="sd">    specific to a mfr.sop such as ge.mr, or siemens.syngo_csa.</span>

<span class="sd">    parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str</span>
<span class="sd">        path to input file</span>
<span class="sd">    load_data : bool [default False]</span>
<span class="sd">        indicate if all data should be loaded by invoking load_data() at the end of init.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">domain</span> <span class="o">=</span> <span class="s">u&#39;mr&#39;</span>  <span class="c"># for now assuming all dicoms are MR</span>
    <span class="n">filetype</span> <span class="o">=</span> <span class="s">u&#39;dicom&#39;</span>
    <span class="n">priority</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">parse_priority</span> <span class="o">=</span> <span class="mi">9</span>
    <span class="n">state</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;orig&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">load_data</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse a single file from the input.</span>

<span class="sd">        Performs manufacturer specific single dicom parsing.</span>

<span class="sd">        calls mfr sop specific parse_one method</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NIMSDicom</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">load_data</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">archive</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ti</span> <span class="ow">in</span> <span class="n">archive</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span> <span class="o">=</span> <span class="n">MetaExtractor</span><span class="p">(</span><span class="n">dicom</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">cStringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">archive</span><span class="o">.</span><span class="n">extractfile</span><span class="p">(</span><span class="n">ti</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()),</span> <span class="n">stop_before_pixels</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
                <span class="k">except</span> <span class="p">(</span><span class="n">dicom</span><span class="o">.</span><span class="n">filereader</span><span class="o">.</span><span class="n">InvalidDicomError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                    <span class="c"># dicom.filereader.InvalidDicomError, not a dicom</span>
                    <span class="c"># AttributeError,</span>
                    <span class="c"># ValueError, dcmstack.extract, tag value not parseable with declared VR</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NIMSDicomError</span><span class="p">(</span><span class="s">&#39;no header could be extracted&#39;</span><span class="p">)</span>  <span class="c"># XXX FAIL! unexpected to not extract header</span>
        <span class="k">del</span> <span class="n">ti</span><span class="p">,</span> <span class="n">archive</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">image_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getelem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="p">,</span> <span class="s">&#39;ImageType&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manufacturer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getelem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="p">,</span> <span class="s">&#39;Manufacturer&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">manufacturer</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_type</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sub</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;CSA&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">manufacturer</span> <span class="o">=</span> <span class="s">&#39;SIEMENS&#39;</span>
                    <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sop_class_uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getelem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="p">,</span> <span class="s">&#39;SOPClassUID&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">manufacturer</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;could not determine manufacturer from dicom header&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sop_class_uid</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;SOP Class UID not set in dicom header&#39;</span><span class="p">)</span>

        <span class="n">mfr</span> <span class="o">=</span> <span class="n">SUPPORTED_MFR</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manufacturer</span><span class="p">)</span>
        <span class="n">sop</span> <span class="o">=</span> <span class="n">SUPPORTED_SOP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sop_class_uid</span><span class="p">)</span>
        <span class="n">composer</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;dcm&#39;</span><span class="p">,</span> <span class="n">sop</span><span class="p">,</span> <span class="n">mfr</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">_temp</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">composer</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="n">fromlist</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;parse_one&#39;</span><span class="p">,</span> <span class="s">&#39;parse_all&#39;</span><span class="p">,</span> <span class="s">&#39;convert&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;no composer match. parsing basic info only.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse_one</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">(</span><span class="n">_temp</span><span class="o">.</span><span class="n">parse_one</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>  <span class="c"># types.MethodType(fxn, i), turn fxn into method of instance</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse_all</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">(</span><span class="n">_temp</span><span class="o">.</span><span class="n">parse_all</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">convert</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">(</span><span class="n">_temp</span><span class="o">.</span><span class="n">convert</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;composing from </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">composer</span><span class="p">)</span>

        <span class="c"># standard dicoms stuff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exam_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getelem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="p">,</span> <span class="s">&#39;StudyID&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exam_uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getelem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="p">,</span> <span class="s">&#39;StudyInstanceUID&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patient_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getelem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="p">,</span> <span class="s">&#39;PatientID&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">series_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getelem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="p">,</span> <span class="s">&#39;SeriesNumber&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">series_desc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getelem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="p">,</span> <span class="s">&#39;SeriesDescription&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">series_uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getelem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="p">,</span> <span class="s">&#39;SeriesInstanceUID&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subj_code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_name</span> <span class="o">=</span> <span class="n">medimg</span><span class="o">.</span><span class="n">parse_patient_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patient_id</span><span class="p">,</span> <span class="s">&#39;ex&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">exam_no</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acq_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getelem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="p">,</span> <span class="s">&#39;AcquisitionNumber&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c"># wrong for siemens dicom, until load_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">study_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getelem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="p">,</span> <span class="s">&#39;StudyDate&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">study_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getelem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="p">,</span> <span class="s">&#39;StudyTime&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acq_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getelem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="p">,</span> <span class="s">&#39;AcquisitionDate&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acq_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getelem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="p">,</span> <span class="s">&#39;AcquisitionTime&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">study_datetime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">study_date</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">study_time</span> <span class="ow">and</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">study_date</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">study_time</span><span class="p">[:</span><span class="mi">6</span><span class="p">],</span> <span class="s">&#39;%Y%m</span><span class="si">%d</span><span class="s">%H%M%S&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acq_datetime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acq_date</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">acq_time</span> <span class="ow">and</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acq_date</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">acq_time</span><span class="p">[:</span><span class="mi">6</span><span class="p">],</span> <span class="s">&#39;%Y%m</span><span class="si">%d</span><span class="s">%H%M%S&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acq_datetime</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">study_datetime</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subj_firstname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subj_lastname</span> <span class="o">=</span> <span class="n">medimg</span><span class="o">.</span><span class="n">parse_patient_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getelem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="p">,</span> <span class="s">&#39;PatientName&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subj_dob</span> <span class="o">=</span> <span class="n">medimg</span><span class="o">.</span><span class="n">parse_patient_dob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getelem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="p">,</span> <span class="s">&#39;PatientBirthDate&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subj_sex</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;M&#39;</span><span class="p">:</span> <span class="s">&#39;male&#39;</span><span class="p">,</span> <span class="s">&#39;F&#39;</span><span class="p">:</span> <span class="s">&#39;female&#39;</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getelem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="p">,</span> <span class="s">&#39;PatientSex&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scanner_name</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">getelem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="p">,</span> <span class="s">&#39;InstitutionName&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">getelem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="p">,</span> <span class="s">&#39;StationName&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">),</span>
                <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manufacturer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getelem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="p">,</span> <span class="s">&#39;Manufacturer&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manufacturer_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getelem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="p">,</span> <span class="s">&#39;ManufacturerModelName&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scanner_type</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">manufacturer</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">manufacturer_model</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getelem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hdr</span><span class="p">,</span> <span class="s">&#39;OperatorsName&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phase_encode_direction</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c"># FIXME: how do diff mfr&#39;s store phase_encode_direction??</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nims_metadata_status</span> <span class="o">=</span> <span class="s">&#39;pending&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parse_one</span><span class="p">()</span>  <span class="c"># COMPOSED; parses mfr sop specific data</span>

        <span class="k">if</span> <span class="n">load_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>

<div class="viewcode-block" id="NIMSDicom.parse_one"><a class="viewcode-back" href="../../../nimsdata.html#nimsdata.medimg.nimsdicom.NIMSDicom.parse_one">[docs]</a>    <span class="k">def</span> <span class="nf">parse_one</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;No-op.&quot;&quot;&quot;</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="NIMSDicom.parse_all"><a class="viewcode-back" href="../../../nimsdata.html#nimsdata.medimg.nimsdicom.NIMSDicom.parse_all">[docs]</a>    <span class="k">def</span> <span class="nf">parse_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;No-op.&quot;&quot;&quot;</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="NIMSDicom.convert"><a class="viewcode-back" href="../../../nimsdata.html#nimsdata.medimg.nimsdicom.NIMSDicom.convert">[docs]</a>    <span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;No-op.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
</div>
<div class="viewcode-block" id="NIMSDicom.load_data"><a class="viewcode-back" href="../../../nimsdata.html#nimsdata.medimg.nimsdicom.NIMSDicom.load_data">[docs]</a>    <span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load all dicoms and obtain more metadata.</span>

<span class="sd">        Performs manufacturer specific loads. Operates through side-effect, does not return anything.</span>

<span class="sd">        calls mfr sop specific parse_all and convert functions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NIMSDicom</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dcm_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">archive</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ti</span> <span class="ow">in</span> <span class="n">archive</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dcm</span> <span class="o">=</span> <span class="n">dicom</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">cStringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">archive</span><span class="o">.</span><span class="n">extractfile</span><span class="p">(</span><span class="n">ti</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()),</span> <span class="n">stop_before_pixels</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getelem</span><span class="p">(</span><span class="n">dcm</span><span class="p">,</span> <span class="s">&#39;SOPClassUID&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sop_class_uid</span><span class="p">:</span>  <span class="c"># mismatch SOP, do not attempt recon</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;dicoms have inconsistent SOP Class UIDs&#39;</span><span class="p">)</span>  <span class="c"># XXX expected error</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">is_non_image</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_dcm_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dcm</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="n">dicom</span><span class="o">.</span><span class="n">filereader</span><span class="o">.</span><span class="n">InvalidDicomError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
                    <span class="k">pass</span>
        <span class="k">del</span> <span class="n">ti</span><span class="p">,</span> <span class="n">archive</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dcm_list</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="k">raise</span> <span class="n">NIMSDicomError</span><span class="p">(</span><span class="s">&#39;no dicoms loaded?&#39;</span><span class="p">)</span>  <span class="c"># XXX FAIL! unexpected for no dicoms to be loaded</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dcm_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dcm</span><span class="p">:</span> <span class="n">dcm</span><span class="o">.</span><span class="n">InstanceNumber</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;dicoms do not have InstanceNumber. cannot pre-sort&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parse_all</span><span class="p">()</span>  <span class="c"># COMPOSED; parses mfr sop specifics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nims_metadata_status</span> <span class="o">=</span> <span class="s">&#39;complete&#39;</span>  <span class="c"># if parse_all completes, metadata is assumed to be completed</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">convert</span><span class="p">()</span>  <span class="c"># COMPOSED; converts mfr sop specific, may also do last round of metadata touch ups</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> pixel data could not be loaded: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">failure_reason</span> <span class="o">=</span> <span class="n">e</span>

</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="NIMSDicom.getelem"><a class="viewcode-back" href="../../../nimsdata.html#nimsdata.medimg.nimsdicom.NIMSDicom.getelem">[docs]</a>    <span class="k">def</span> <span class="nf">getelem</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">type_</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve a dicom header element by its tag.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        hdr : pydicom.dataset or csa_dict from dcmstack.extact.MetaExtractor</span>
<span class="sd">            Either a pydicom.dataset object, or a NestedMultiDict as returned by dcmstack.extract.MetaExtractor.</span>
<span class="sd">        tag : tuple or str</span>
<span class="sd">            A tuple or string that indicates which tag to retrieve.  The tuple tag can only be used with a pydicom.dataset.</span>
<span class="sd">        type_ : class</span>
<span class="sd">            Attempt to convert the tag&#39;s value to the specified type, such as str, int, float.  Default is None.</span>
<span class="sd">        default : any</span>
<span class="sd">            What value to return if the tag cannot be found, or if type conversion fails.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        value : any</span>
<span class="sd">            the value held at the tag specificed, of type `type_` (if possible).  Or the default value if</span>
<span class="sd">            the tag does not exist, or could not be converted to `type_`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">default</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="c"># get by bytecode tuple</span>
            <span class="n">elem</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">elem</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># get by keyword</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">type_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">type_</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">type_</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>   <span class="c"># TypeError, for Nones, ValueError for casting</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">default</span>
        <span class="k">return</span> <span class="n">value</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">NIMSData  documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, Author.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>